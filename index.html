<script>
    // 1. DANH SÃCH áº¢NH (Thay link cá»§a Ã´ng vÃ o)
    // Tui sáº½ dÃ¹ng 4 áº£nh Ä‘áº§u cá»§a má»—i danh sÃ¡ch Ä‘á»ƒ chia 4 trÃ¡i - 4 pháº£i nha
     const photos1 = [

        "./images/anh1.jpg.JPG",

        "./images/anh2.jpg.jpg",

        "./images/anh3.jpg.JPG",

        "./images/anh4.jpg.JPG",

    ];

    const photos2 = [

        "./images/anh5.jpg.JPG",

        "./images/anh6.jpg.JPEG",

        "./images/anh7.jpg.PNG",

        "./images/anh8.jpg.jpg"

    ];

    // --- ğŸ“ Báº¢N Äá»’ Vá»Š TRÃ CHUáº¨N (4 TRÃI - 4 PHáº¢I) ---
    // x: Khoáº£ng cÃ¡ch ngang (Ã¢m lÃ  trÃ¡i, dÆ°Æ¡ng lÃ  pháº£i). ThÆ° rá»™ng ~320, nÃªn x > 180 lÃ  an toÃ n.
    // y: Äá»™ cao (Ã¢m lÃ  trÃªn, dÆ°Æ¡ng lÃ  dÆ°á»›i). Hoa cao ~160 tá»« Ä‘Ã¡y, nÃªn y < 150 lÃ  an toÃ n.

    // 4 Vá»‹ trÃ­ bÃªn TRÃI (Xáº¿p dÃ­ch dáº¯c)
    const posLeft = [
        { x: -320, y: -150, r: -15 }, // 1. TrÃªn cao, xa
        { x: -220, y: -50,  r: 5 },   // 2. Giá»¯a trÃªn, gáº§n
        { x: -320, y: 50,   r: -10 }, // 3. Giá»¯a dÆ°á»›i, xa
        { x: -220, y: 140,  r: 10 }   // 4. DÆ°á»›i tháº¥p, gáº§n (váº«n cao hÆ¡n hoa)
    ];

    // 4 Vá»‹ trÃ­ bÃªn PHáº¢I (Äá»‘i xá»©ng láº¡i)
    const posRight = [
        { x: 320, y: -150, r: 15 },  // 1. TrÃªn cao, xa
        { x: 220, y: -50,  r: -5 },  // 2. Giá»¯a trÃªn, gáº§n
        { x: 320, y: 50,   r: 10 },  // 3. Giá»¯a dÆ°á»›i, xa
        { x: 220, y: 140,  r: -10 }  // 4. DÆ°á»›i tháº¥p, gáº§n
    ];


    const universe = document.getElementById('universe');
    for(let i=0; i<150; i++) {
        let s = document.createElement('div'); s.className = 'star';
        s.style.width = s.style.height = Math.random() * 2 + 'px';
        s.style.left = Math.random() * 100 + 'vw'; s.style.top = Math.random() * 200 + 'vh';
        universe.appendChild(s);
    }
    setInterval(() => {
        let h = document.createElement('div'); h.className = 'bg-heart'; h.innerHTML = 'â¤ï¸';
        h.style.left = Math.random() * 100 + 'vw'; h.style.fontSize = Math.random() * 15 + 10 + 'px';
        universe.appendChild(h); setTimeout(() => h.remove(), 6000);
    }, 400);

    function typeLine(elementId, text, speed, callback) {
        let i = 0; let el = document.getElementById(elementId);
        function type() {
            if (i < text.length) { el.innerHTML += text.charAt(i); i++; setTimeout(type, speed); } 
            else if (callback) { setTimeout(callback, 200); }
        }
        type();
    }

    // --- LOGIC Má» THÆ¯ (DÃ™NG Báº¢N Äá»’ Má»šI) ---
    function openLetter() {
        document.getElementById('env').classList.add('open');
        document.getElementById('btn-open').style.opacity = '0';
        setTimeout(() => document.getElementById('btn-open').style.display = 'none', 500);

        let group1Els = []; let group2Els = []; 

        // ğŸ”¥ NHÃ“M TRÃI: Láº¥y 4 áº£nh Ä‘áº§u cá»§a photos1 Ä‘áº·t vÃ o vá»‹ trÃ­ bÃªn trÃ¡i
        for(let i=0; i<4; i++) {
            let url = photos1[i];
            let p = posLeft[i];
            
            let img = document.createElement('div'); img.className = 'photo-card';
            img.innerHTML = `<img src="${url}">`; 
            img.style.left = '50%'; img.style.top = '45%'; img.style.transform = 'translate(-50%, -50%) scale(0)';
            
            document.getElementById('scene1').appendChild(img); group1Els.push(img);
            
            img.style.setProperty('--x', `calc(-50% + ${p.x}px)`); 
            img.style.setProperty('--y', `calc(-50% + ${p.y}px)`); 
            img.style.setProperty('--r', `${p.r}deg`);
            
            setTimeout(() => { 
                img.style.opacity = '1'; 
                img.style.transform = `translate(var(--x), var(--y)) rotate(var(--r))`; 
                setTimeout(() => { img.style.animation = `floatInfo ${3 + Math.random()}s ease-in-out infinite alternate`; }, 1500); 
            }, i * 150);
        }

        // ğŸ”¥ NHÃ“M PHáº¢I: Láº¥y 4 áº£nh Ä‘áº§u cá»§a photos2 Ä‘áº·t vÃ o vá»‹ trÃ­ bÃªn pháº£i
        for(let i=0; i<4; i++) {
            let url = photos2[i];
            let p = posRight[i];

            let img = document.createElement('div'); img.className = 'photo-card';
            img.innerHTML = `<img src="${url}">`; 
            img.style.left = '50%'; img.style.top = '45%'; 
            document.getElementById('scene1').appendChild(img); group2Els.push(img);
            
            img.style.setProperty('--x', `calc(-50% + ${p.x}px)`); 
            img.style.setProperty('--y', `calc(-50% + ${p.y}px)`); 
            img.style.setProperty('--r', `${p.r}deg`);
            
            // NhÃ³m nÃ y áº©n trÆ°á»›c, bay ra Ä‘Ãºng vá»‹ trÃ­
            img.style.transform = `translate(var(--x), var(--y)) rotate(var(--r))`; 
            img.style.opacity = '0';
            img.style.animation = `floatInfo ${3 + Math.random()}s ease-in-out infinite alternate`;
        }

        // Hiá»‡u á»©ng áº©n hiá»‡n luÃ¢n phiÃªn 2 nhÃ³m trÃ¡i pháº£i
        setTimeout(() => {
            let showGroup1 = true;
            setInterval(() => {
                if(!document.body.classList.contains('in-scene2')) {
                    showGroup1 = !showGroup1;
                    if(showGroup1) { group2Els.forEach(img => img.style.opacity = '0'); setTimeout(() => { group1Els.forEach(img => img.style.opacity = '1'); }, 1000);
                    } else { group1Els.forEach(img => img.style.opacity = '0'); setTimeout(() => { group2Els.forEach(img => img.style.opacity = '1'); }, 1000); }
                }
            }, 3500);
        }, 3000);

        // GÃµ thÆ° vÃ  hiá»‡n Sticker
        setTimeout(() => {
            setTimeout(() => {
                document.querySelectorAll('.sticker').forEach(s => {
                    s.style.opacity = '1';
                    s.style.transform = 'scale(1) rotate(var(--r, 0deg))';
                });
            }, 1000);

            typeLine('line1', "Gá»­i em Nu,", 50, () => {
                typeLine('line2', "HÃ´m nay chÃ­nh lÃ  Valentine Ä‘Ã³ nhaaa, thÃ¬ cÅ©m nhÃ¢n dá»‹p nÃ y anh Zinh cÃ³ chuáº©n bá»‹ má»™t mÃ³n quÃ  \"handmade\" dÃ nh cho em Ä‘Ã³ nhaaa.", 30, () => { 
                    typeLine('line3', "Tuy nÃ³ nhá» vá»›i hÆ¡i nham nhá»Ÿ xÃ­ nhÆ°ng mÃ  anh Ä‘Ã£ dÃ nh ráº¥t nhiá»u tÃ¢m huyáº¿t Ä‘á»ƒ lÃ m ra nÃ³ Ä‘Ã³ hihi ( Táº¡i anh hong rÃ nh code web cho láº¯m :)) ) mong lÃ  em sáº½ thÃ­ch háº¹ háº¹.", 30, () => {
                        typeLine('line4', "Dá» thÃ¬ lÃ m theo chá»‰ dáº«n Ä‘i nhe babi!!", 50, () => {
                            const nextBtn = document.getElementById('btn-next-right');
                            nextBtn.style.opacity = '1';
                            nextBtn.style.pointerEvents = 'auto';
                        });
                    });
                });
            });
        }, 1200);
    }

    const storyline = [
        ["Gá»­i bÃ© Nu cá»§a anh"],
        ["NgÃ y hÃ´m nay", "cá»§a em tháº¿ nÃ o?"],
        ["DÃ¹ mÆ°a hay náº¯ng", "dÃ¹ vui hay buá»“n"],
        ["ThÃ¬ hÃ£y nhá»› ká»¹", "Ä‘iá»u nÃ y nhÃ©:"],
        ["LuÃ´n cÃ³ anh Zinh", "Ä‘á»©ng sau lÆ°ng em"],
        ["Sáºµn sÃ ng che chá»Ÿ", "vÃ  yÃªu chiá»u em"],
        ["VÃ¬ em xá»©ng Ä‘Ã¡ng", "vá»›i nhá»¯ng gÃ¬ tá»‘t nháº¥t"],
        ["MÃ£i háº¡nh phÃºc", "bÃªn anh nha!"],
        ["Happy Valentine,", "My Everything ğŸ’–"]
    ];

    async function goToScene2() {
        document.body.classList.add('in-scene2');
        document.getElementById('btn-next-right').style.opacity = '0';
        document.getElementById('btn-next-right').style.pointerEvents = 'none';
        
        await new Promise(r => setTimeout(r, 1500));
        document.fonts.ready.then(async () => {
            for (let lines of storyline) {
                await shootSinglePhrase(lines);
            }
            const btnDown = document.getElementById('btn-down-arrow');
            btnDown.style.opacity = '1'; btnDown.style.pointerEvents = 'auto';
        });
    }

    function getTextPoints(lines) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        ctx.font = '900 100px Quicksand'; 
        
        let maxW = 0;
        lines.forEach(line => {
            let w = ctx.measureText(line).width;
            if(w > maxW) maxW = w;
        });
        
        canvas.width = maxW + 100; 
        canvas.height = lines.length * 120 + 50; 
        
        ctx.font = '900 100px Quicksand'; 
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const lineSpacing = 110; 
        let startY = (canvas.height - (lines.length - 1) * lineSpacing) / 2;

        lines.forEach((line, index) => {
            ctx.fillText(line, canvas.width / 2, startY + index * lineSpacing);
        });

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        const points = [];
        
        const step = 6; 
        for (let y = 0; y < canvas.height; y += step) {
            for (let x = 0; x < canvas.width; x += step) {
                if (imageData[(y * canvas.width + x) * 4 + 3] > 128) {
                    points.push({ x: x - canvas.width/2, y: y - canvas.height/2 });
                }
            }
        }
        return { points, baseWidth: canvas.width };
    }

    function shootSinglePhrase(lines) {
        return new Promise(resolve => {
            const { points, baseWidth } = getTextPoints(lines);
            const scene2 = document.getElementById('scene2');
            const startX = 80; const startY = window.innerHeight - 50; 
            const centerX = window.innerWidth / 2 + 10; const centerY = window.innerHeight / 2 - 50; 
            
            let hearts = [];
            
            let availableWidth = window.innerWidth * 0.9; 
            let scaleFactor = availableWidth / baseWidth;
            if (scaleFactor > 1.0) scaleFactor = 1.0; 

            let maxPoints = 1000; 
            let filteredPoints = points;
            if (points.length > maxPoints) {
                let ratio = maxPoints / points.length;
                filteredPoints = points.filter(() => Math.random() < ratio);
            }

            filteredPoints.forEach((pt, i) => {
                let heart = document.createElement('div'); 
                heart.className = 'mini-heart'; 
                heart.innerHTML = 'â¤ï¸';
                heart.style.left = startX + 'px'; heart.style.top = startY + 'px'; 
                heart.style.transform = `translate(-50%, -50%) scale(0)`;
                scene2.appendChild(heart);
                hearts.push(heart);

                let destX = centerX + (pt.x * scaleFactor); 
                let destY = centerY + (pt.y * scaleFactor);
                
                setTimeout(() => { 
                    heart.style.transform = `translate(calc(${destX}px - ${startX}px), calc(${destY}px - ${startY}px)) scale(1) rotate(0deg)`; 
                }, i * 3); 
            });

            const shootTime = filteredPoints.length * 3;
            const readTime = 2500; 
            
            setTimeout(() => {
                hearts.forEach(h => {
                    h.style.opacity = '0';
                    h.style.transform += ' translateY(-30px)'; 
                });
                
                setTimeout(() => {
                    hearts.forEach(h => h.remove());
                    resolve();
                }, 1500); 

            }, shootTime + readTime);
        });
    }

    function scrollDownToScene3() {
        document.getElementById('btn-down-arrow').style.opacity = '0';
        document.getElementById('btn-down-arrow').style.pointerEvents = 'none';
        document.getElementById('universe').style.transform = 'translateY(-100vh)';
        setTimeout(() => { initLiXunHeart(); }, 1500);
    }

    function initLiXunHeart() {
        var canvas = document.getElementById('pinkboard');
        var context = canvas.getContext('2d');
        var particles = [];
        var particleRate = 400; 
        var time = 0;

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        function pointOnHeart(t) {
            return {
                x: 160 * Math.pow(Math.sin(t), 3),
                y: 130 * Math.cos(t) - 50 * Math.cos(2 * t) - 20 * Math.cos(3 * t) - 10 * Math.cos(4 * t)
            };
        }

        class Particle {
            constructor() {
                var t = Math.random() * Math.PI * 2;
                var pos = pointOnHeart(t);
                var dir = Math.random() * Math.PI * 2;
                var spread = Math.random() * 40; 
                if(Math.random() < 0.5) spread *= Math.random() * 2; 

                this.x = pos.x + Math.cos(dir) * spread;
                this.y = -pos.y + Math.sin(dir) * spread; 
                this.size = Math.random() * 2 + 1.5; 
                this.life = 0;
                this.maxLife = Math.random() * 100 + 50;
            }
            update() { this.life++; return this.life < this.maxLife; }
            draw(ctx, scale) {
                var opacity = 1 - (this.life / this.maxLife);
                ctx.fillStyle = `rgba(255, 0, 85, ${opacity})`;
                var drawX = (canvas.width / 2) + this.x * scale;
                var drawY = (canvas.height / 2) + this.y * scale;
                ctx.shadowBlur = 10; ctx.shadowColor = "#ff0055";
                ctx.beginPath(); ctx.arc(drawX, drawY, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function render() {
            context.globalCompositeOperation = 'destination-out';
            context.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.globalCompositeOperation = 'source-over';

            time += 0.05;
            var scale = 1 + 0.15 * Math.pow(Math.sin(time * 1.5), 6); 

            for (let i = 0; i < particleRate / 10; i++) { particles.push(new Particle()); }
            for (let i = 0; i < particles.length; i++) {
                if (particles[i].update()) { particles[i].draw(context, scale); } 
                else { particles.splice(i, 1); i--; }
            }
            requestAnimationFrame(render);
        }
        render();
    }
</script>
